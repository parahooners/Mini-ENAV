<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini ENAV Controller</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
            margin-bottom: 0;
        }
        h1 {
            margin: 0;
        }
        
        /* Tab Navigation Styles */
        .tab-navigation {
            background-color: #444;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .tab-navigation a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .tab-navigation a:hover {
            background-color: #555;
        }
        .tab-navigation a.active {
            background-color: #4CAF50;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        iframe.external-site {
            width: 100%;
            height: 800px;
            border: none;
            overflow: hidden;
        }
        /* End Tab Navigation Styles */
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #map {
            height: 100%;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.disconnect {
            background-color: #f44336;
        }
        select, input {
            padding: 8px;
            margin: 5px 0;
            display: block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
        }
        .flex-row {
            display: flex;
            gap: 10px;
        }
        .flex-row > * {
            flex: 1;
        }
        .location-item {
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        #locationList {
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            background-color: #f0f0f0;
            min-height: 20px;
        }
        #serialMonitor {
            width: 100%;
            height: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            font-family: monospace;
            background-color: #2e2e2e;
            color: #f0f0f0;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Mini ENAV Controller</h1>
    </header>
    
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <a href="#home" class="tab-link active" data-tab="home-content">Home</a>
        <a href="store.html" class="tab-link">Store</a>
        <a href="#asselect" class="tab-link" data-tab="asselect-content">AS Select</a>
        <a href="#notam" class="tab-link" data-tab="notam-content">NOTAM</a>
        <a href="#docs" class="tab-link" data-tab="docs-content">Documentation</a>
    </div>
    
    <!-- Tab Contents -->
    <div id="home-content" class="tab-content active">
        <div class="container">
            <div class="controls">
                <div class="control-panel">
                    <h2>Connection</h2>
                    <button id="connectBtn">Connect to Mini ENAV</button>
                    <button id="disconnectBtn" class="disconnect" disabled>Disconnect</button>
                    <div id="connectionStatus" class="status">Not connected</div>
                    
                    <h2>Location Management</h2>
                    <div class="flex-row">
                        <div>
                            <label for="locationName">Location ID:</label>
                            <select id="locationName">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div>
                            <label for="locationStatus">Status:</label>
                            <select id="locationStatus">
                                <option value="ON">ON</option>
                                <option value="OFF">OFF</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex-row">
                        <div>
                            <label for="latitude">Latitude:</label>
                            <input type="number" id="latitude" step="0.000001" placeholder="Click on map">
                        </div>
                        <div>
                            <label for="longitude">Longitude:</label>
                            <input type="number" id="longitude" step="0.000001" placeholder="Click on map">
                        </div>
                    </div>
                    
                    <button id="sendLocationBtn" disabled>Send Location</button>
                    
                    <h2>Saved Locations</h2>
                    <div id="locationList"></div>
                </div>
                
                <div class="control-panel">
                    <h2>Serial Monitor</h2>
                    <div id="serialMonitor"></div>
                    <button id="clearMonitorBtn">Clear Monitor</button>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <div id="asselect-content" class="tab-content">
        <div class="container">
            <h2>AS Select Aviation Tool</h2>
            <div class="control-panel">
                <p><strong>External Website Notice:</strong> The content below is embedded from <a href="https://asselect.uk/" target="_blank">asselect.uk</a>, an external website. This tool is owned and maintained by its respective authors and is not affiliated with Mini ENAV.</p>
                <p>AS Select is a tool developed by <a href="https://asselect.uk/contact.html" target="_blank">Phil Haeberli</a> to assist pilots with aviation-related calculations and airspace information. All rights and credit for this tool belong to its original creators.</p>
                <p>For any issues with the AS Select tool itself, please contact the website owners directly through their official website.</p>
            </div>
            <iframe src="https://asselect.uk/" class="external-site" title="AS Select"></iframe>
        </div>
    </div>
    
    <div id="notam-content" class="tab-content">
        <div class="container">
            <h2>NOTAM Information</h2>
            <div class="control-panel">
                <p><strong>External Website Notice:</strong> The content below is embedded from <a href="https://notaminfo.com/ukmap" target="_blank">notaminfo.com/ukmap</a>, an external website. This tool is owned and maintained by its respective authors and is not affiliated with Mini ENAV.</p>
                <p>NOTAM Info is a service that provides Notice to Air Missions (NOTAM) information for pilots and aviation personnel. All rights and credit for this tool belong to its original creators.</p>
                <p>For any issues with the NOTAM Info tool itself, please contact the website owners directly through their official website.</p>
            </div>
            <iframe src="https://notaminfo.com/ukmap" class="external-site" title="NOTAM Info UK Map"></iframe>
        </div>
    </div>
    
    <div id="docs-content" class="tab-content">
        <div class="container">
            <h2>Mini ENAV Documentation</h2>
            <p>Documentation and help resources for the Mini ENAV system.</p>
            <div class="control-panel">
                <h3>Getting Started</h3>
                <p>Welcome to the Mini ENAV Controller documentation. This section will contain guides and resources to help you use your Mini ENAV device effectively.</p>
                
                <h3>Features</h3>
                <ul>
                    <li>GPS Navigation</li>
                    <li>Bluetooth Connectivity</li>
                    <li>Location Management</li>
                    <li>Low Power Consumption</li>
                </ul>
                
                <h3>Troubleshooting</h3>
                <p>Common issues and their solutions will be listed here.</p>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Tab Navigation Logic
        document.querySelectorAll('.tab-link').forEach(tab => {
            tab.addEventListener('click', function(event) {
                // Check if the tab is an external link (has no data-tab attribute)
                const tabId = this.getAttribute('data-tab');
                if (!tabId) {
                    // This is an external link (like store.html), let the default navigation happen
                    return;
                }
                
                // For internal tabs, prevent default navigation
                event.preventDefault();
                
                // Deactivate all tabs and contents
                document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Activate the clicked tab and content
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // BLE UUIDs
        const ENAV_SERVICE_UUID = "7a41c6c2-e9cd-4136-9cbd-8a791086a566";
        const LOCATION_CHAR_UUID = "98dcc5a5-d9fb-4fcc-be63-bf8a2eb4bcb4";
        const RESPONSE_CHAR_UUID = "5bc4de8a-ed52-41a7-9e53-f8e927a0ee55";
        const LOCATIONS_LIST_UUID = "7bc4de8a-ed52-41a7-9e53-f8e927a0ee56"; // New characteristic for getting locations list
        
        // Global BLE variables
        let bleDevice = null;
        let bleServer = null;
        let enaService = null;
        let locationChar = null;
        let responseChar = null;
        
        // UI Elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const locationNameSelect = document.getElementById('locationName');
        const locationStatusSelect = document.getElementById('locationStatus');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const sendLocationBtn = document.getElementById('sendLocationBtn');
        const locationList = document.getElementById('locationList');
        const serialMonitor = document.getElementById('serialMonitor');
        const clearMonitorBtn = document.getElementById('clearMonitorBtn');
        
        // Stored locations
        const savedLocations = {};
        
        // Initialize map
        const map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Markers collection
        const markers = {};
        
        // Add click event to map
        map.on('click', function(e) {
            latitudeInput.value = e.latlng.lat.toFixed(6);
            longitudeInput.value = e.latlng.lng.toFixed(6);
        });
        
        // BLE Connection
        connectBtn.addEventListener('click', async () => {
            try {
                logToMonitor('Requesting Bluetooth device...');
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Mini ENAV' }],
                    optionalServices: [ENAV_SERVICE_UUID]
                });
                
                logToMonitor('Connecting to GATT server...');
                bleServer = await bleDevice.gatt.connect();
                
                logToMonitor('Getting Mini ENAV service...');
                enaService = await bleServer.getPrimaryService(ENAV_SERVICE_UUID);
                
                logToMonitor('Getting characteristics...');
                locationChar = await enaService.getCharacteristic(LOCATION_CHAR_UUID);
                responseChar = await enaService.getCharacteristic(RESPONSE_CHAR_UUID);
                
                // Setup notifications for response characteristic
                await responseChar.startNotifications();
                responseChar.addEventListener('characteristicvaluechanged', handleResponseNotification);
                
                // Update UI
                connectionStatus.textContent = 'Connected to Mini ENAV';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendLocationBtn.disabled = false;
                
                // Setup disconnect listener
                bleDevice.addEventListener('gattserverdisconnected', handleDisconnect);
                
                logToMonitor('Connected to Mini ENAV!');
                
                // Request saved locations from the device
                await requestSavedLocations();
            } catch (error) {
                logToMonitor(`Connection error: ${error}`);
                connectionStatus.textContent = `Connection failed: ${error}`;
            }
        });
        
        // Disconnect from device
        disconnectBtn.addEventListener('click', () => {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            } else {
                resetConnectionUI();
            }
        });
        
        // Handle disconnection
        function handleDisconnect() {
            logToMonitor('Disconnected from Mini ENAV');
            resetConnectionUI();
        }
        
        // Reset UI on disconnect
        function resetConnectionUI() {
            connectionStatus.textContent = 'Not connected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            sendLocationBtn.disabled = true;
            bleDevice = null;
            bleServer = null;
            enaService = null;
            locationChar = null;
            responseChar = null;
        }
        
        // Handle notifications from the response characteristic
        function handleResponseNotification(event) {
            const value = new TextDecoder().decode(event.target.value);
            
            // Check if the message is a location data response
            if (value.startsWith("LOC_DATA:")) {
                try {
                    // Parse the location data from the response
                    const locData = value.substring(9); // Remove "LOC_DATA:" prefix
                    const locationObj = JSON.parse(locData);
                    
                    // Add to saved locations and update UI
                    savedLocations[locationObj.name] = locationObj;
                    updateLocationsList();
                    
                    // Add marker to map
                    updateMapMarker(
                        locationObj.name, 
                        locationObj.lat, 
                        locationObj.lon, 
                        locationObj.active ? "ON" : "OFF"
                    );
                    
                    logToMonitor(`Loaded location ${locationObj.name} from device`);
                } catch (error) {
                    logToMonitor(`Error parsing location data: ${error}`);
                }
            } else {
                logToMonitor(`Response: ${value}`);
            }
        }
        
        // Request stored locations from the device
        async function requestSavedLocations() {
            if (!locationChar) {
                logToMonitor('Not connected to device!');
                return;
            }
            
            logToMonitor('Requesting saved locations from Mini ENAV...');
            
            try {
                // Send request for locations
                const encoder = new TextEncoder();
                await locationChar.writeValue(encoder.encode("GET_LOCATIONS"));
                
                logToMonitor('Location request sent. Waiting for device response...');
            } catch (error) {
                logToMonitor(`Request error: ${error}`);
            }
        }
        
        // Send location to device
        sendLocationBtn.addEventListener('click', async () => {
            if (!locationChar) {
                logToMonitor('Not connected to device!');
                return;
            }
            
            const name = locationNameSelect.value;
            const status = locationStatusSelect.value;
            const lat = parseFloat(latitudeInput.value).toFixed(6);
            const lon = parseFloat(longitudeInput.value).toFixed(6);
            
            if (isNaN(lat) || isNaN(lon)) {
                logToMonitor('Invalid coordinates!');
                return;
            }
            
            // Prepare the data string: Name-Lat-Lon-Status
            const data = `${name}-${lat}-${lon}-${status}`;
            logToMonitor(`Sending: ${data}`);
            
            try {
                // Convert string to bytes and send
                const encoder = new TextEncoder();
                await locationChar.writeValue(encoder.encode(data));
                
                // Save the location
                savedLocations[name] = {
                    name,
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    status
                };
                
                // Update marker on the map
                updateMapMarker(name, parseFloat(lat), parseFloat(lon), status);
                
                // Update saved locations list
                updateLocationsList();
                
            } catch (error) {
                logToMonitor(`Send error: ${error}`);
            }
        });
        
        // Update or create a marker on the map
        function updateMapMarker(name, lat, lon, status) {
            // Remove existing marker if it exists
            if (markers[name]) {
                map.removeLayer(markers[name]);
            }
            
            // Don't add marker if status is OFF
            if (status === 'OFF') {
                delete markers[name];
                return;
            }
            
            // Format coordinates with consistent decimal places
            const formattedLat = parseFloat(lat).toFixed(6);
            const formattedLon = parseFloat(lon).toFixed(6);
            
            // Create icon based on the location name
            const markerIcon = L.divIcon({
                html: `<div style="
                    background-color: #2b3be4;
                    color: white;
                    border-radius: 50%;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    border: 2px solid white;
                    box-shadow: 0 0 5px rgba(0,0,0,0.5);
                ">${name}</div>`,
                className: '',
                iconSize: [28, 28]
            });
            
            // Create the marker with formatted coordinates
            markers[name] = L.marker([lat, lon], { icon: markerIcon })
                .addTo(map)
                .bindPopup(`Location ${name}<br>Lat: ${formattedLat}<br>Lon: ${formattedLon}`);
            
            // Center map on the most recently added marker
            map.setView([lat, lon], 13);
        }
        
        // Update the list of saved locations
        function updateLocationsList() {
            locationList.innerHTML = '';
            
            for (const id in savedLocations) {
                const location = savedLocations[id];
                // Format longitude with fixed 6 decimal places to ensure consistency
                const formattedLat = parseFloat(location.lat).toFixed(6);
                const formattedLon = parseFloat(location.lon).toFixed(6);
                
                const locationElement = document.createElement('div');
                locationElement.className = 'location-item';
                locationElement.innerHTML = `
                    <strong>${location.name}</strong> (${location.active ? "ON" : "OFF"})<br>
                    Lat: ${formattedLat}, Lon: ${formattedLon}
                    <button class="load-btn" data-id="${location.name}">Load</button>
                `;
                locationList.appendChild(locationElement);
            }
            
            // Add event listeners to load buttons
            document.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const location = savedLocations[id];
                    
                    locationNameSelect.value = location.name;
                    locationStatusSelect.value = location.active ? "ON" : "OFF";
                    latitudeInput.value = parseFloat(location.lat).toFixed(6);
                    longitudeInput.value = parseFloat(location.lon).toFixed(6);
                });
            });
        }
        
        // Log messages to the serial monitor
        function logToMonitor(message) {
            const timestamp = new Date().toLocaleTimeString();
            serialMonitor.innerHTML += `[${timestamp}] ${message}<br>`;
            serialMonitor.scrollTop = serialMonitor.scrollHeight;
        }
        
        // Clear the serial monitor
        clearMonitorBtn.addEventListener('click', () => {
            serialMonitor.innerHTML = '';
        });
        
        // Check if Web Bluetooth is available
        if (!navigator.bluetooth) {
            logToMonitor('Web Bluetooth API is not available in your browser!');
            connectBtn.disabled = true;
            connectionStatus.textContent = 'Web Bluetooth not supported in this browser';
        } else {
            logToMonitor('Web Bluetooth API is available! Click "Connect" to begin.');
        }
    </script>
</body>
</html>