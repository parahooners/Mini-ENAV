<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini ENAV BLE Interface</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .status, .map, .poi, .serial {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        input {
            padding: 5px;
            font-size: 14px;
            width: 150px;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-top: 10px;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <h1>Mini ENAV BLE Interface</h1>
        <div class="status">
            <p><strong>Connection Status:</strong> <span id="connection-status">Disconnected</span></p>
            <button id="connect-btn">Connect to BLE</button>
            <div id="fuel-data" style="margin-top: 10px;">
                <p><strong>Fuel Level:</strong> <span id="fuel-litres">--</span> L</p>
                <p><strong>Burn Rate:</strong> <span id="fuel-burnrate">--</span> L/h</p>
                <p><strong>Flight Time:</strong> <span id="flight-time">--</span> hrs</p>
            </div>
        </div>
        <div class="map">
            <h2>Map Interface</h2>
            <p>Click on the map to select POI locations. The latitude and longitude will be displayed below.</p>
            <div id="map"></div>
            <div>
                <label for="poi1-name">POI 1 Name:</label>
                <input type="text" id="poi1-name" maxlength="4" placeholder="Name">
                <label for="poi1-lat">Lat:</label>
                <input type="text" id="poi1-lat" readonly>
                <label for="poi1-lon">Lon:</label>
                <input type="text" id="poi1-lon" readonly>
            </div>
            <div>
                <label for="poi2-name">POI 2 Name:</label>
                <input type="text" id="poi2-name" maxlength="4" placeholder="Name">
                <label for="poi2-lat">Lat:</label>
                <input type="text" id="poi2-lat" readonly>
                <label for="poi2-lon">Lon:</label>
                <input type="text" id="poi2-lon" readonly>
            </div>
            <div>
                <label for="poi3-name">POI 3 Name:</label>
                <input type="text" id="poi3-name" maxlength="4" placeholder="Name">
                <label for="poi3-lat">Lat:</label>
                <input type="text" id="poi3-lat" readonly>
                <label for="poi3-lon">Lon:</label>
                <input type="text" id="poi3-lon" readonly>
            </div>
            <button id="send-poi-btn">Send POI Data</button>
        </div>
        <div class="serial">
            <h2>Serial Communication</h2>
            <textarea id="serial-output" rows="10" cols="50" readonly placeholder="Received data will appear here..."></textarea>
        </div>
    </div>

    <script>
        let bleDevice = null;
        let bleCharacteristic = null;

        const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
        const CHARACTERISTIC_UUID = "abcdef01-1234-5678-1234-56789abcdef0";

        const connectBtn = document.getElementById("connect-btn");
        const connectionStatus = document.getElementById("connection-status");
        const sendPoiBtn = document.getElementById("send-poi-btn");
        const serialOutput = document.getElementById("serial-output");

        let selectedPOI = 1;

        function initMap() {
            const map = L.map("map").setView([0, 0], 2);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on("click", (event) => {
                const lat = event.latlng.lat.toFixed(6);
                const lon = event.latlng.lng.toFixed(6);

                if (selectedPOI === 1) {
                    document.getElementById("poi1-lat").value = lat;
                    document.getElementById("poi1-lon").value = lon;
                } else if (selectedPOI === 2) {
                    document.getElementById("poi2-lat").value = lat;
                    document.getElementById("poi2-lon").value = lon;
                } else if (selectedPOI === 3) {
                    document.getElementById("poi3-lat").value = lat;
                    document.getElementById("poi3-lon").value = lon;
                }

                selectedPOI = (selectedPOI % 3) + 1; // Cycle through POIs
            });
        }

        connectBtn.addEventListener("click", async () => {
            try {
                connectionStatus.textContent = "Connecting...";
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: "Mini ENAV" }],
                    optionalServices: [SERVICE_UUID]
                });

                console.log('Connecting to GATT Server...');
                const server = await bleDevice.gatt.connect();

                console.log('Getting Service...');
                const service = await server.getPrimaryService(SERVICE_UUID);

                console.log('Getting Characteristic...');
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                // Start notifications
                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);

                connectionStatus.textContent = "Connected";

                // Request initial fuel data
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode("GET_FUEL"));
                
                // Add disconnect handler
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error("Connection failed:", error);
                connectionStatus.textContent = "Disconnected";
                resetFuelData();
            }
        });

        function resetFuelData() {
            document.getElementById("fuel-litres").textContent = "--";
            document.getElementById("fuel-burnrate").textContent = "--";
            document.getElementById("flight-time").textContent = "--";
        }

        function onDisconnected() {
            connectionStatus.textContent = "Disconnected";
            resetFuelData();
            console.log('Device disconnected');
        }

        sendPoiBtn.addEventListener("click", async () => {
            if (!bleCharacteristic) {
                alert("Please connect to BLE first.");
                return;
            }

            const poi1Name = document.getElementById("poi1-name").value || "----";
            const poi1Lat = document.getElementById("poi1-lat").value || "0";
            const poi1Lon = document.getElementById("poi1-lon").value || "0";

            const poi2Name = document.getElementById("poi2-name").value || "----";
            const poi2Lat = document.getElementById("poi2-lat").value || "0";
            const poi2Lon = document.getElementById("poi2-lon").value || "0";

            const poi3Name = document.getElementById("poi3-name").value || "----";
            const poi3Lat = document.getElementById("poi3-lat").value || "0";
            const poi3Lon = document.getElementById("poi3-lon").value || "0";

            // Updated data format to include coordinates
            const data = `POI1:${poi1Name}:${poi1Lat}:${poi1Lon},POI2:${poi2Name}:${poi2Lat}:${poi2Lon},POI3:${poi3Name}:${poi3Lat}:${poi3Lon},`; // Added trailing comma
            try {
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode(data));
                serialOutput.value += "Sending: " + data + "\n";
                // Removed premature success alert: alert("POI data sent successfully.");
            } catch (error) {
                console.error("Failed to send POI data", error);
                serialOutput.value += "Error sending data: " + error.message + "\n";
                alert("Error sending POI data: " + error.message); // Notify user of error
            }
        });

        function handleNotification(event) {
            const decoder = new TextDecoder();
            const value = decoder.decode(event.target.value);
            
            console.log("Raw notification received:", value); // Log raw value
            // Display ALL received notifications in the serial output first
            serialOutput.value += "Received: " + value + "\n";
            serialOutput.scrollTop = serialOutput.scrollHeight;

            if (value.startsWith("FUEL:")) {
                console.log("Processing FUEL data...");
                const parts = value.split(":");
                console.log("Split parts:", parts); // Log split parts
                if (parts.length === 4) {
                    const [_, litres, burnrate, time] = parts;
                    console.log(`Parsed values: Litres=${litres}, Burnrate=${burnrate}, Time=${time}`);
                    if (litres !== undefined && burnrate !== undefined && time !== undefined) {
                        document.getElementById("fuel-litres").textContent = parseFloat(litres).toFixed(1);
                        document.getElementById("fuel-burnrate").textContent = parseFloat(burnrate).toFixed(1);
                        document.getElementById("flight-time").textContent = parseFloat(time).toFixed(1);
                        console.log("Fuel display updated.");
                    } else {
                        console.error("Fuel data parsing resulted in undefined values.");
                    }
                } else {
                     console.error("Incorrect number of parts in FUEL data:", parts.length);
                }
            } else if (value.startsWith("Updated POIs:")) {
                // Provide feedback when POI update is confirmed
                alert("Device confirmed POI update: " + value);
            } else if (value.startsWith("STATUS:")) {
                // Status messages are already logged above, no extra action needed here
                // unless you want specific parsing/display elsewhere.
                console.log("Processing STATUS data (already logged).");
            } else if (value === "Ready") {
                 console.log("Device reported Ready state.");
            } else {
                console.warn("Received unknown notification format:", value);
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
